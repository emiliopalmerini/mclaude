// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: usage.sql

package sqlc

import (
	"context"
	"database/sql"
)

const getPlanConfig = `-- name: GetPlanConfig :one
SELECT id, plan_type, window_hours, learned_token_limit, learned_at, created_at, updated_at, window_start_time, weekly_window_start_time, weekly_learned_token_limit, weekly_learned_at FROM plan_config WHERE id = 1
`

func (q *Queries) GetPlanConfig(ctx context.Context) (PlanConfig, error) {
	row := q.db.QueryRowContext(ctx, getPlanConfig)
	var i PlanConfig
	err := row.Scan(
		&i.ID,
		&i.PlanType,
		&i.WindowHours,
		&i.LearnedTokenLimit,
		&i.LearnedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.WindowStartTime,
		&i.WeeklyWindowStartTime,
		&i.WeeklyLearnedTokenLimit,
		&i.WeeklyLearnedAt,
	)
	return i, err
}

const getRollingWindowUsage = `-- name: GetRollingWindowUsage :one
SELECT
    CAST(COALESCE(SUM(m.token_cache_read + m.token_cache_write), 0) AS REAL) as total_tokens,
    CAST(COALESCE(SUM(m.cost_estimate_usd), 0) AS REAL) as total_cost
FROM sessions s
JOIN session_metrics m ON s.id = m.session_id
WHERE datetime(s.started_at) >= datetime((
    SELECT COALESCE(window_start_time, datetime('now', ? || ' hours'))
    FROM plan_config WHERE id = 1
))
`

type GetRollingWindowUsageRow struct {
	TotalTokens float64 `json:"total_tokens"`
	TotalCost   float64 `json:"total_cost"`
}

func (q *Queries) GetRollingWindowUsage(ctx context.Context, dollar_1 sql.NullString) (GetRollingWindowUsageRow, error) {
	row := q.db.QueryRowContext(ctx, getRollingWindowUsage, dollar_1)
	var i GetRollingWindowUsageRow
	err := row.Scan(&i.TotalTokens, &i.TotalCost)
	return i, err
}

const getWeeklyWindowUsage = `-- name: GetWeeklyWindowUsage :one
SELECT
    CAST(COALESCE(SUM(m.token_cache_read + m.token_cache_write), 0) AS REAL) as total_tokens,
    CAST(COALESCE(SUM(m.cost_estimate_usd), 0) AS REAL) as total_cost
FROM sessions s
JOIN session_metrics m ON s.id = m.session_id
WHERE datetime(s.started_at) >= datetime((
    SELECT COALESCE(weekly_window_start_time, datetime('now', '-168 hours'))
    FROM plan_config WHERE id = 1
))
`

type GetWeeklyWindowUsageRow struct {
	TotalTokens float64 `json:"total_tokens"`
	TotalCost   float64 `json:"total_cost"`
}

func (q *Queries) GetWeeklyWindowUsage(ctx context.Context) (GetWeeklyWindowUsageRow, error) {
	row := q.db.QueryRowContext(ctx, getWeeklyWindowUsage)
	var i GetWeeklyWindowUsageRow
	err := row.Scan(&i.TotalTokens, &i.TotalCost)
	return i, err
}

const updateLearnedLimit = `-- name: UpdateLearnedLimit :exec
UPDATE plan_config
SET learned_token_limit = ?, learned_at = datetime('now'), updated_at = datetime('now')
WHERE id = 1
`

func (q *Queries) UpdateLearnedLimit(ctx context.Context, learnedTokenLimit sql.NullFloat64) error {
	_, err := q.db.ExecContext(ctx, updateLearnedLimit, learnedTokenLimit)
	return err
}

const updateWeeklyLearnedLimit = `-- name: UpdateWeeklyLearnedLimit :exec
UPDATE plan_config
SET weekly_learned_token_limit = ?, weekly_learned_at = datetime('now'), updated_at = datetime('now')
WHERE id = 1
`

func (q *Queries) UpdateWeeklyLearnedLimit(ctx context.Context, weeklyLearnedTokenLimit sql.NullFloat64) error {
	_, err := q.db.ExecContext(ctx, updateWeeklyLearnedLimit, weeklyLearnedTokenLimit)
	return err
}

const updateWeeklyWindowStartTime = `-- name: UpdateWeeklyWindowStartTime :exec
UPDATE plan_config SET weekly_window_start_time = ?, updated_at = datetime('now') WHERE id = 1
`

func (q *Queries) UpdateWeeklyWindowStartTime(ctx context.Context, weeklyWindowStartTime sql.NullString) error {
	_, err := q.db.ExecContext(ctx, updateWeeklyWindowStartTime, weeklyWindowStartTime)
	return err
}

const updateWindowStartTime = `-- name: UpdateWindowStartTime :exec
UPDATE plan_config SET window_start_time = ?, updated_at = datetime('now') WHERE id = 1
`

func (q *Queries) UpdateWindowStartTime(ctx context.Context, windowStartTime sql.NullString) error {
	_, err := q.db.ExecContext(ctx, updateWindowStartTime, windowStartTime)
	return err
}

const upsertPlanConfig = `-- name: UpsertPlanConfig :exec
INSERT INTO plan_config (id, plan_type, window_hours, learned_token_limit, learned_at, updated_at)
VALUES (1, ?, ?, ?, ?, datetime('now'))
ON CONFLICT (id) DO UPDATE SET
    plan_type = excluded.plan_type,
    window_hours = excluded.window_hours,
    learned_token_limit = excluded.learned_token_limit,
    learned_at = excluded.learned_at,
    updated_at = datetime('now')
`

type UpsertPlanConfigParams struct {
	PlanType          string          `json:"plan_type"`
	WindowHours       int64           `json:"window_hours"`
	LearnedTokenLimit sql.NullFloat64 `json:"learned_token_limit"`
	LearnedAt         sql.NullString  `json:"learned_at"`
}

func (q *Queries) UpsertPlanConfig(ctx context.Context, arg UpsertPlanConfigParams) error {
	_, err := q.db.ExecContext(ctx, upsertPlanConfig,
		arg.PlanType,
		arg.WindowHours,
		arg.LearnedTokenLimit,
		arg.LearnedAt,
	)
	return err
}
