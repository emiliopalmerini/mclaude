package templates

import "fmt"

templ SessionReviewPage(data SessionReviewData) {
	@Layout("Review Session") {
		<div class="space-y-6">
			<!-- Header -->
			<div class="page-header">
				@Breadcrumbs([]BreadcrumbItem{
					{Label: "Sessions", Href: "/sessions"},
					{Label: truncateID(data.ID), Href: "/sessions/" + data.ID},
					{Label: "Review", Href: ""},
				})
				<div class="page-header-content">
					<div class="page-header-left">
						<h1 class="page-title">Review Session</h1>
						if data.Quality.ReviewedAt != "" {
							<span class="badge badge-green">Reviewed</span>
						} else {
							<span class="badge badge-yellow">Needs Review</span>
						}
					</div>
				</div>
			</div>

			<!-- Quick Stats -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				@StatCard("Turns", fmt.Sprintf("%d", data.TurnCount), "")
				@StatCard("Tokens", formatTokens(data.TokenInput + data.TokenOutput + data.TokenCacheRead + data.TokenCacheWrite), fmt.Sprintf("%s in / %s out / %s cache", formatTokens(data.TokenInput), formatTokens(data.TokenOutput), formatTokens(data.TokenCacheRead + data.TokenCacheWrite)))
				@StatCard("Cost", fmt.Sprintf("$%.4f", data.CostEstimateUsd), "")
				@StatCard("Errors", fmt.Sprintf("%d", data.ErrorCount), "")
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<!-- Quality Form (1/3 width) -->
				<div class="lg:col-span-1">
					@QualityReviewForm(data.ID, data.Quality)
				</div>

				<!-- Transcript Viewer (2/3 width) -->
				<div class="lg:col-span-2">
					@TranscriptViewer(data.ID, data.Transcript)
				</div>
			</div>
		</div>
	}
}

templ QualityReviewForm(sessionID string, quality SessionQuality) {
	<div class="quality-form sticky top-4" x-data={ fmt.Sprintf(`{
		isSuccess: %s,
		overallRating: %d,
		accuracyRating: %d,
		helpfulnessRating: %d,
		efficiencyRating: %d,
		saved: false,
		saving: false,
		setSuccess(val) {
			this.isSuccess = val;
			this.save();
		},
		setRating(field, val) {
			this[field] = val;
			this.save();
		},
		save() {
			this.saving = true;
			const form = this.$refs.form;
			const params = new URLSearchParams();
			params.set('is_success', this.isSuccess === null ? '' : (this.isSuccess ? '1' : '0'));
			params.set('overall_rating', this.overallRating);
			params.set('accuracy_rating', this.accuracyRating);
			params.set('helpfulness_rating', this.helpfulnessRating);
			params.set('efficiency_rating', this.efficiencyRating);
			params.set('notes', form.querySelector('[name=notes]').value || '');
			fetch(form.action, {
				method: 'POST',
				headers: {'Content-Type': 'application/x-www-form-urlencoded'},
				body: params
			}).then(() => {
				this.saved = true;
				this.saving = false;
				setTimeout(() => this.saved = false, 2000);
			});
		}
	}`, boolToJS(quality.IsSuccess), quality.OverallRating, quality.AccuracyRating, quality.HelpfulnessRating, quality.EfficiencyRating) }>
		<h2>Quality Assessment</h2>

		<form x-ref="form" action={ templ.SafeURL("/api/sessions/" + sessionID + "/quality") } method="POST" class="space-y-6">
			<!-- Success/Failure Toggle -->
			<div class="rating-section">
				<label>Outcome</label>
				<div class="outcome-toggle">
					<button type="button"
						class="outcome-btn"
						:class="isSuccess === true ? 'success-active' : ''"
						@click="setSuccess(true)">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						Success
					</button>
					<button type="button"
						class="outcome-btn"
						:class="isSuccess === false ? 'failure-active' : ''"
						@click="setSuccess(false)">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						Failure
					</button>
				</div>
				<input type="hidden" name="is_success" :value="isSuccess === null ? '' : (isSuccess ? '1' : '0')"/>
			</div>

			<!-- Overall Rating -->
			<div class="rating-section">
				<label>Overall Rating</label>
				<div class="star-rating">
					for i := 1; i <= 5; i++ {
						<button type="button"
							class="star-btn"
							:class={ fmt.Sprintf("overallRating >= %d ? 'filled' : ''", i) }
							@click={ fmt.Sprintf("setRating('overallRating', %d)", i) }>
							&#9733;
						</button>
					}
					<button type="button"
						class="star-clear"
						x-show="overallRating > 0"
						@click="setRating('overallRating', 0)">
						Clear
					</button>
				</div>
				<input type="hidden" name="overall_rating" :value="overallRating"/>
			</div>

			<!-- Detailed Ratings -->
			<div class="rating-section">
				<label>Accuracy</label>
				<div class="star-rating">
					for i := 1; i <= 5; i++ {
						<button type="button"
							class="star-btn"
							:class={ fmt.Sprintf("accuracyRating >= %d ? 'filled' : ''", i) }
							@click={ fmt.Sprintf("setRating('accuracyRating', %d)", i) }>
							&#9733;
						</button>
					}
					<button type="button"
						class="star-clear"
						x-show="accuracyRating > 0"
						@click="setRating('accuracyRating', 0)">
						Clear
					</button>
				</div>
				<input type="hidden" name="accuracy_rating" :value="accuracyRating"/>
			</div>

			<div class="rating-section">
				<label>Helpfulness</label>
				<div class="star-rating">
					for i := 1; i <= 5; i++ {
						<button type="button"
							class="star-btn"
							:class={ fmt.Sprintf("helpfulnessRating >= %d ? 'filled' : ''", i) }
							@click={ fmt.Sprintf("setRating('helpfulnessRating', %d)", i) }>
							&#9733;
						</button>
					}
					<button type="button"
						class="star-clear"
						x-show="helpfulnessRating > 0"
						@click="setRating('helpfulnessRating', 0)">
						Clear
					</button>
				</div>
				<input type="hidden" name="helpfulness_rating" :value="helpfulnessRating"/>
			</div>

			<div class="rating-section">
				<label>Efficiency</label>
				<div class="star-rating">
					for i := 1; i <= 5; i++ {
						<button type="button"
							class="star-btn"
							:class={ fmt.Sprintf("efficiencyRating >= %d ? 'filled' : ''", i) }
							@click={ fmt.Sprintf("setRating('efficiencyRating', %d)", i) }>
							&#9733;
						</button>
					}
					<button type="button"
						class="star-clear"
						x-show="efficiencyRating > 0"
						@click="setRating('efficiencyRating', 0)">
						Clear
					</button>
				</div>
				<input type="hidden" name="efficiency_rating" :value="efficiencyRating"/>
			</div>

			<!-- Notes -->
			<div class="rating-section">
				<label>Notes</label>
				<textarea name="notes"
					class="notes-textarea"
					placeholder="Optional observations..."
					@change="save()">{ quality.Notes }</textarea>
			</div>

			<!-- Save Indicator -->
			<div id="save-indicator" class="save-indicator">
				<span x-show="saving" class="saving">Saving...</span>
				<span x-show="saved && !saving" class="saved">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 1rem; height: 1rem;">
						<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
					</svg>
					Saved
				</span>
			</div>
		</form>
	</div>
}

templ StarRatingInput(name, alpineVar string) {
	<div class="flex gap-1">
		for i := 1; i <= 5; i++ {
			<button type="button"
				class="text-2xl focus:outline-none transition-colors"
				:class={ fmt.Sprintf("%s >= %d ? 'text-yellow-400' : 'text-gray-300 hover:text-yellow-200'", alpineVar, i) }
				@click={ fmt.Sprintf("setRating('%s', %d)", alpineVar, i) }>
				&#9733;
			</button>
		}
		<button type="button"
			class="text-sm text-gray-400 hover:text-gray-600 ml-2"
			:class={ fmt.Sprintf("%s > 0 ? '' : 'hidden'", alpineVar) }
			@click={ fmt.Sprintf("setRating('%s', 0)", alpineVar) }>
			clear
		</button>
	</div>
	<input type="hidden" name={ name } :value={ alpineVar }/>
}

templ TranscriptViewer(sessionID string, messages []TranscriptMessage) {
	<div class="script-container" x-data x-init="$nextTick(() => { marked.setOptions({ breaks: true, mangle: false, headerIds: false }); document.querySelectorAll('.markdown-content').forEach(el => { let t = el.textContent; t = t.split(String.fromCharCode(60)).join('&lt;'); t = t.split(String.fromCharCode(62)).join('&gt;'); el.innerHTML = marked.parse(t); }); })">
		<div class="script-header">
			<span class="script-title">Session Transcript</span>
			<span class="script-meta">{ fmt.Sprintf("%d", len(messages)) } messages</span>
		</div>

		if len(messages) == 0 {
			<p class="text-gray-500">No transcript available</p>
		} else {
			<div class="script-content">
				for _, msg := range messages {
					@TranscriptMessageComponent(msg)
				}
			</div>
		}
	</div>
}

templ TranscriptMessageComponent(msg TranscriptMessage) {
	<div class="script-block">
		<div class="script-character">
			if msg.Role == "user" {
				YOU
			} else {
				CLAUDE
			}
		</div>

		if msg.Content != "" {
			<div class="script-dialogue markdown-content">{ msg.Content }</div>
		}

		if len(msg.Tools) > 0 {
			<details class="script-tools">
				<summary class="script-tools-summary">
					Tools ({ fmt.Sprintf("%d", len(msg.Tools)) })
				</summary>
				<div class="script-tools-content">
					for _, tool := range msg.Tools {
						<div class="script-action">
							<span class="script-action-name">{ tool.Name }</span>
							if tool.Input != "" {
								<pre class="script-action-detail">{ tool.Input }</pre>
							}
						</div>
					}
				</div>
			</details>
		}
	</div>
}

templ QualitySavedIndicator() {
	<span class="text-green-600">Saved!</span>
}

func messageBgClass(role string) string {
	if role == "user" {
		return "bg-blue-50"
	}
	return "bg-gray-100"
}

func messageLabelClass(role string) string {
	if role == "user" {
		return "text-blue-600"
	}
	return "text-gray-600"
}

func boolToJS(b *bool) string {
	if b == nil {
		return "null"
	}
	if *b {
		return "true"
	}
	return "false"
}

func formatTimestampShort(ts string) string {
	// Try to parse and format as time only
	// Input format: 2024-01-15T10:30:45.123Z
	if len(ts) >= 19 {
		return ts[11:19] // Extract HH:MM:SS
	}
	return ts
}
