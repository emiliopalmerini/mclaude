package templates

import "fmt"
import "encoding/json"

templ ExperimentComparePage(data ExperimentComparison) {
	@Layout("Compare Experiments", "/experiments") {
		<div class="space-y-4">
			<!-- Header -->
			<div class="page-header">
				@Breadcrumbs([]BreadcrumbItem{
					{Label: "Experiments", Href: "/experiments"},
					{Label: "Compare", Href: ""},
				})
				<div class="page-header-content">
					<h1 class="page-title">Compare Experiments</h1>
				</div>
			</div>

			if len(data.Experiments) < 2 {
				<div class="card text-center py-8">
					<p class="text-gray-500">Select at least 2 experiments to compare</p>
					<a href="/experiments" class="btn btn-primary mt-4">Back to Experiments</a>
				</div>
			} else {
				<!-- Charts -->
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
					<div class="card" x-data={ fmt.Sprintf("comparisonBarChart('compare-bar', %s)", buildCompareJSON(data.Experiments)) } x-init="init()">
						<h2 class="text-sm font-semibold mb-2">Metrics Comparison</h2>
						<div id="compare-bar" style="height: 280px;"></div>
					</div>
					<div class="card" x-data={ fmt.Sprintf("comparisonRadarChart('compare-radar', %s)", buildCompareJSON(data.Experiments)) } x-init="init()">
						<h2 class="text-sm font-semibold mb-2">Efficiency Radar</h2>
						<div id="compare-radar" style="height: 280px;"></div>
					</div>
				</div>

				<!-- Comparison Table -->
				<div class="card overflow-x-auto">
					<table class="w-full">
						<thead>
							<tr class="border-b border-gray-200">
								<th class="text-left py-2 px-4 font-semibold text-gray-600 text-sm">Metric</th>
								for _, exp := range data.Experiments {
									<th class="text-right py-2 px-4 font-semibold text-gray-900 text-sm">
										{ exp.Name }
										if exp.IsActive {
											<span class="badge badge-green ml-2">Active</span>
										}
									</th>
								}
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-100">
							<!-- Sessions -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Sessions</td>
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Total Sessions</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatInt(exp.SessionCount) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Total Turns</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.TotalTurns) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">User Messages</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.UserMessages) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Assistant Messages</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.AssistantMessages) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Errors</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatInt(exp.TotalErrors) }</td>
								}
							</tr>

							<!-- Tokens -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Tokens</td>
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Input Tokens</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.TokenInput) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Output Tokens</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.TokenOutput) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Cache Read</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.CacheRead) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Cache Write</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.CacheWrite) }</td>
								}
							</tr>
							<tr class="font-semibold">
								<td class="py-1.5 px-4 text-gray-700 text-sm">Total Tokens</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right text-sm">{ formatTokens(exp.TotalTokens) }</td>
								}
							</tr>

							<!-- Cost -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Cost</td>
							</tr>
							<tr class="font-semibold">
								<td class="py-1.5 px-4 text-gray-700 text-sm">Total Cost</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right text-sm">{ formatCost(exp.TotalCost) }</td>
								}
							</tr>

							<!-- Efficiency -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Efficiency</td>
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Tokens/Session</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(exp.TokensPerSession) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Cost/Session</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatCostPrecise(exp.CostPerSession) }</td>
								}
							</tr>

							<!-- Behavior -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Behavior</td>
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Tokens/Turn</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatTokens(int64(exp.TokensPerTurn)) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Output Ratio</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ fmt.Sprintf("%.2f", exp.OutputRatio) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Cache Hit Rate</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ fmt.Sprintf("%.1f%%", exp.CacheHitRate*100) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Error Rate</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ fmt.Sprintf("%.2f%%", exp.ErrorRate*100) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Tool Calls/Turn</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ fmt.Sprintf("%.1f", exp.ToolCallsPerTurn) }</td>
								}
							</tr>

							<!-- Quality -->
							<tr class="bg-gray-50">
								<td colspan={ colSpan(len(data.Experiments) + 1) } class="py-1.5 px-4 font-semibold text-gray-700 text-sm">Quality</td>
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Sessions Reviewed</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">{ formatInt(exp.ReviewedCount) }</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Avg Rating</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">
										if exp.AvgOverall != nil {
											{ formatRating(*exp.AvgOverall) }
										} else {
											<span class="text-gray-400">-</span>
										}
									</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Success Rate</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">
										if exp.SuccessRate != nil {
											{ formatPercent(*exp.SuccessRate) }
										} else {
											<span class="text-gray-400">-</span>
										}
									</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Avg Accuracy</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">
										if exp.AvgAccuracy != nil {
											{ formatRating(*exp.AvgAccuracy) }
										} else {
											<span class="text-gray-400">-</span>
										}
									</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Avg Helpfulness</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">
										if exp.AvgHelpfulness != nil {
											{ formatRating(*exp.AvgHelpfulness) }
										} else {
											<span class="text-gray-400">-</span>
										}
									</td>
								}
							</tr>
							<tr>
								<td class="py-1.5 px-4 text-gray-600 text-sm">Avg Efficiency</td>
								for _, exp := range data.Experiments {
									<td class="py-1.5 px-4 text-right font-medium text-sm">
										if exp.AvgEfficiency != nil {
											{ formatRating(*exp.AvgEfficiency) }
										} else {
											<span class="text-gray-400">-</span>
										}
									</td>
								}
							</tr>
						</tbody>
					</table>
				</div>
			}
		</div>
	}
}

func buildCompareJSON(experiments []ExperimentCompareItem) string {
	type chartItem struct {
		Name             string  `json:"name"`
		Sessions         int64   `json:"sessions"`
		TotalTokens      int64   `json:"totalTokens"`
		TotalCost        float64 `json:"totalCost"`
		TokensPerSession int64   `json:"tokensPerSession"`
		CostPerSession   float64 `json:"costPerSession"`
		TotalTurns       int64   `json:"totalTurns"`
		SuccessRate      float64 `json:"successRate"`
		AvgRating        float64 `json:"avgRating"`
		OutputRatio      float64 `json:"outputRatio"`
		CacheHitRate     float64 `json:"cacheHitRate"`
		ToolCallsPerTurn float64 `json:"toolCallsPerTurn"`
	}
	items := make([]chartItem, len(experiments))
	for i, exp := range experiments {
		items[i] = chartItem{
			Name:             exp.Name,
			Sessions:         exp.SessionCount,
			TotalTokens:      exp.TotalTokens,
			TotalCost:        exp.TotalCost,
			TokensPerSession: exp.TokensPerSession,
			CostPerSession:   exp.CostPerSession,
			TotalTurns:       exp.TotalTurns,
			OutputRatio:      exp.OutputRatio,
			CacheHitRate:     exp.CacheHitRate * 100,
			ToolCallsPerTurn: exp.ToolCallsPerTurn,
		}
		if exp.SuccessRate != nil {
			items[i].SuccessRate = *exp.SuccessRate * 100
		}
		if exp.AvgOverall != nil {
			items[i].AvgRating = *exp.AvgOverall
		}
	}
	b, _ := json.Marshal(items)
	return string(b)
}
