package templates

import "fmt"

templ Dashboard(stats DashboardStats) {
	@Layout("Dashboard") {
		<div class="space-y-6">
			<div class="flex items-center justify-between">
				<h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
				if stats.ActiveExperiment != "" {
					<span class="badge badge-green">Experiment: { stats.ActiveExperiment }</span>
				}
			</div>

			<!-- Stats Cards -->
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
				@StatCard("Sessions", fmt.Sprintf("%d", stats.SessionCount), "Total sessions recorded")
				@StatCard("Tokens", formatTokens(stats.TotalTokens), fmt.Sprintf("%s in / %s out / %s cache", formatTokens(stats.TokenInput), formatTokens(stats.TokenOutput), formatTokens(stats.CacheRead + stats.CacheWrite)))
				@CostCard(stats.TotalCost, stats.DefaultModel)
				@QualityDashboardCard(stats.ReviewedCount, stats.SuccessRate, stats.AvgOverall)
				@UsageLimitCard(stats.UsageStats)
			</div>

			<!-- Usage Chart -->
			<div class="card" x-data="usageChart()" x-init="init()">
				<h2 class="text-lg font-semibold mb-4">Daily Usage (Last 30 Days)</h2>
				<div id="usage-chart" style="height: 300px;"></div>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- Top Tools -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Top Tools</h2>
					if len(stats.TopTools) > 0 {
						<div class="space-y-2">
							for _, tool := range stats.TopTools {
								<div class="flex justify-between items-center py-2 border-b last:border-0">
									<span class="font-mono text-sm">{ tool.Name }</span>
									<span class="text-gray-600">{ fmt.Sprintf("%d", tool.Count) } calls</span>
								</div>
							}
						</div>
					} else {
						<p class="text-gray-500">No tool usage recorded yet</p>
					}
				</div>

				<!-- Recent Sessions -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Recent Sessions</h2>
					if len(stats.RecentSessions) > 0 {
						<div class="space-y-2">
							for _, session := range stats.RecentSessions {
								<a href={ templ.SafeURL("/sessions/" + session.ID) } class="block hover:bg-gray-50 -mx-2 px-2 py-2 rounded">
									<div class="flex justify-between items-center">
										<span class="font-mono text-sm text-gray-600">{ truncateID(session.ID) }</span>
										<span class="text-sm text-gray-500">{ formatDateTime(session.CreatedAt) }</span>
									</div>
									<div class="flex justify-between items-center text-sm mt-1">
										<span>{ fmt.Sprintf("%d turns", session.Turns) } · { formatTokens(session.Tokens) } tokens</span>
										<span class="text-green-600">{ fmt.Sprintf("$%.4f", session.Cost) }</span>
									</div>
								</a>
							}
						</div>
					} else {
						<p class="text-gray-500">No sessions recorded yet</p>
					}
				</div>
			</div>
		</div>
	}
}

templ StatCard(title, value, subtitle string) {
	<div class="card">
		<dt class="text-sm font-medium text-gray-500 truncate">{ title }</dt>
		<dd class="mt-1 text-3xl font-semibold text-gray-900">{ value }</dd>
		<dd class="mt-1 text-sm text-gray-500">{ subtitle }</dd>
	</div>
}

templ CostCard(totalCost float64, defaultModel string) {
	<div class="card">
		<dt class="text-sm font-medium text-gray-500 truncate">Cost</dt>
		<dd class="mt-1 text-3xl font-semibold text-gray-900">{ fmt.Sprintf("$%.4f", totalCost) }</dd>
		<dd class="mt-1 text-sm text-gray-500">
			if defaultModel != "" {
				{ defaultModel }
			} else {
				No model configured
			}
		</dd>
	</div>
}

templ QualityDashboardCard(reviewedCount int64, successRate *float64, avgOverall *float64) {
	<div class="card">
		<dt class="text-sm font-medium text-gray-500 truncate">Quality</dt>
		if reviewedCount == 0 {
			<dd class="mt-1 text-3xl font-semibold text-gray-400">—</dd>
			<dd class="mt-1 text-sm text-gray-500">No reviews yet</dd>
		} else {
			<dd class="mt-1 flex items-center gap-2">
				if successRate != nil {
					<span class="text-2xl font-bold text-green-600">{ formatPercent(*successRate) }</span>
				}
				if avgOverall != nil {
					<span class="text-2xl font-bold text-yellow-500">{ formatRating(*avgOverall) }</span>
				}
			</dd>
			<dd class="mt-1 text-sm text-gray-500">{ fmt.Sprintf("%d reviewed", reviewedCount) }</dd>
		}
	</div>
}

templ UsageLimitCard(stats *UsageLimitStats) {
	<div class="card">
		if stats == nil {
			<dt class="text-sm font-medium text-gray-500 truncate">Usage Limits</dt>
			<dd class="mt-1 text-3xl font-semibold text-gray-400">—</dd>
			<dd class="mt-1 text-sm text-gray-500">No plan configured</dd>
		} else {
			<dt class="text-sm font-medium text-gray-500 truncate">Usage Limits ({ planDisplayName(stats.PlanType) })</dt>
			<!-- 5-Hour Window -->
			<dd class="mt-2">
				<div class="flex items-center justify-between">
					<span class="text-xs text-gray-500">5-hour</span>
					<div class="flex items-center gap-1">
						<span class={ "text-lg font-bold", templ.KV("text-green-600", stats.Status == "OK"), templ.KV("text-yellow-500", stats.Status == "WARNING"), templ.KV("text-red-600", stats.Status == "EXCEEDED") }>
							{ formatUsagePercent(stats.UsagePercent) }
						</span>
						<span class={ "text-xs px-1 py-0.5 rounded", templ.KV("bg-green-100 text-green-700", stats.Status == "OK"), templ.KV("bg-yellow-100 text-yellow-700", stats.Status == "WARNING"), templ.KV("bg-red-100 text-red-700", stats.Status == "EXCEEDED") }>
							{ stats.Status }
						</span>
					</div>
				</div>
				<div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
					<div
						class={ "h-1.5 rounded-full transition-all", templ.KV("bg-green-500", stats.Status == "OK"), templ.KV("bg-yellow-500", stats.Status == "WARNING"), templ.KV("bg-red-500", stats.Status == "EXCEEDED") }
						style={ fmt.Sprintf("width: %.0f%%", min(stats.UsagePercent, 100)) }
					></div>
				</div>
				<div class="text-xs text-gray-400 mt-0.5">
					{ formatTokensFloat(stats.TokensUsed) } / { formatTokensFloat(stats.TokenLimit) }
					if stats.IsLearned {
						<span class="text-blue-500">·L</span>
					}
				</div>
			</dd>
			<!-- Weekly Window -->
			<dd class="mt-3">
				<div class="flex items-center justify-between">
					<span class="text-xs text-gray-500">Weekly</span>
					<div class="flex items-center gap-1">
						<span class={ "text-lg font-bold", templ.KV("text-green-600", stats.WeeklyStatus == "OK"), templ.KV("text-yellow-500", stats.WeeklyStatus == "WARNING"), templ.KV("text-red-600", stats.WeeklyStatus == "EXCEEDED") }>
							{ formatUsagePercent(stats.WeeklyUsagePercent) }
						</span>
						<span class={ "text-xs px-1 py-0.5 rounded", templ.KV("bg-green-100 text-green-700", stats.WeeklyStatus == "OK"), templ.KV("bg-yellow-100 text-yellow-700", stats.WeeklyStatus == "WARNING"), templ.KV("bg-red-100 text-red-700", stats.WeeklyStatus == "EXCEEDED") }>
							{ stats.WeeklyStatus }
						</span>
					</div>
				</div>
				<div class="w-full bg-gray-200 rounded-full h-1.5 mt-1">
					<div
						class={ "h-1.5 rounded-full transition-all", templ.KV("bg-green-500", stats.WeeklyStatus == "OK"), templ.KV("bg-yellow-500", stats.WeeklyStatus == "WARNING"), templ.KV("bg-red-500", stats.WeeklyStatus == "EXCEEDED") }
						style={ fmt.Sprintf("width: %.0f%%", min(stats.WeeklyUsagePercent, 100)) }
					></div>
				</div>
				<div class="text-xs text-gray-400 mt-0.5">
					{ formatTokensFloat(stats.WeeklyTokensUsed) } / { formatTokensFloat(stats.WeeklyTokenLimit) }
					if stats.WeeklyIsLearned {
						<span class="text-blue-500">·L</span>
					}
				</div>
			</dd>
		}
	</div>
}
