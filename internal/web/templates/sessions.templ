package templates

import "fmt"

templ Sessions(sessions []SessionSummary) {
	@Layout("Sessions") {
		<div class="space-y-6">
			<div class="page-header">
				<div class="page-header-content">
					<h1 class="page-title">Sessions</h1>
				</div>
			</div>

			<div class="card overflow-hidden">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="table-header">ID</th>
							<th class="table-header">Date</th>
							<th class="table-header">Turns</th>
							<th class="table-header">Tokens</th>
							<th class="table-header">Cost</th>
							<th class="table-header">Quality</th>
							<th class="table-header">Exit</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						for _, s := range sessions {
							<tr class="hover:bg-gray-50">
								<td class="table-cell font-mono">
									<a href={ templ.SafeURL("/sessions/" + s.ID) } class="text-blue-600 hover:underline">{ truncateID(s.ID) }</a>
								</td>
								<td class="table-cell">{ formatDateTime(s.CreatedAt) }</td>
								<td class="table-cell">{ fmt.Sprintf("%d", s.Turns) }</td>
								<td class="table-cell">{ formatTokens(s.Tokens) }</td>
								<td class="table-cell text-green-600">{ fmt.Sprintf("$%.4f", s.Cost) }</td>
								<td class="table-cell">
									@QualityIndicator(s.IsReviewed, s.OverallRating, s.IsSuccess)
								</td>
								<td class="table-cell">
									<span class={ "badge", exitReasonBadge(s.ExitReason) }>{ s.ExitReason }</span>
								</td>
							</tr>
						}
					</tbody>
				</table>
				if len(sessions) == 0 {
					<div class="p-8 text-center text-gray-500">No sessions found</div>
				}
			</div>
		</div>
	}
}

templ SessionDetailPage(session SessionDetail) {
	@Layout("Session Detail") {
		<div class="space-y-6">
			<div class="page-header">
				@Breadcrumbs([]BreadcrumbItem{
					{Label: "Sessions", Href: "/sessions"},
					{Label: truncateID(session.ID), Href: ""},
				})
				<div class="page-header-content">
					<div class="page-header-left">
						<h1 class="page-title font-mono">{ truncateID(session.ID) }</h1>
						<span class={ "badge", exitReasonBadge(session.ExitReason) }>{ session.ExitReason }</span>
					</div>
					<div class="page-header-actions">
						<a href={ templ.SafeURL("/sessions/" + session.ID + "/review") } class="btn btn-primary">
							Review Session
						</a>
					</div>
				</div>
			</div>

			<!-- Metrics Cards -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				@StatCard("Turns", fmt.Sprintf("%d", session.TurnCount), "Conversation turns")
				@StatCard("Tokens", formatTokens(session.TokenInput + session.TokenOutput + session.TokenCacheRead + session.TokenCacheWrite), fmt.Sprintf("%s in / %s out / %s cache", formatTokens(session.TokenInput), formatTokens(session.TokenOutput), formatTokens(session.TokenCacheRead + session.TokenCacheWrite)))
				@StatCard("Cost", fmt.Sprintf("$%.4f", session.CostEstimateUsd), "Estimated cost")
				@QualityStatCard(session.Quality)
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- Details -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Details</h2>
					<dl class="space-y-3">
						@DetailRow("Project", truncateID(session.ProjectID))
						@DetailRow("Working Directory", session.Cwd)
						@DetailRow("Permission Mode", session.PermissionMode)
						@DetailRow("Created", formatDateTime(session.CreatedAt))
						if session.StartedAt != "" {
							@DetailRow("Started", formatDateTime(session.StartedAt))
						}
						if session.EndedAt != "" {
							@DetailRow("Ended", formatDateTime(session.EndedAt))
						}
					</dl>
				</div>

				<!-- Tools -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Tools Used</h2>
					if len(session.Tools) > 0 {
						<div class="space-y-2">
							for _, tool := range session.Tools {
								<div class="flex justify-between items-center py-2 border-b last:border-0">
									<span class="font-mono text-sm">{ tool.Name }</span>
									<span class="text-gray-600">{ fmt.Sprintf("%d", tool.Count) }x</span>
								</div>
							}
						</div>
					} else {
						<p class="text-gray-500">No tools used</p>
					}
				</div>
			</div>

			<!-- Files -->
			if len(session.Files) > 0 {
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Files Accessed</h2>
					<div class="space-y-1 max-h-64 overflow-y-auto">
						for _, file := range session.Files {
							<div class="flex justify-between items-center py-1 text-sm">
								<span class="font-mono text-gray-700 truncate">{ file.Path }</span>
								<span class={ "badge", opBadge(file.Operation) }>{ file.Operation }</span>
							</div>
						}
					</div>
				</div>
			}
		</div>
	}
}

templ DetailRow(label, value string) {
	<div class="flex justify-between">
		<dt class="text-gray-500">{ label }</dt>
		<dd class="text-gray-900 font-mono text-sm">{ value }</dd>
	</div>
}

func exitReasonBadge(reason string) string {
	switch reason {
	case "exit":
		return "badge-green"
	case "clear":
		return "badge-yellow"
	default:
		return "badge-gray"
	}
}

func opBadge(op string) string {
	switch op {
	case "read":
		return "badge-blue"
	case "write":
		return "badge-green"
	case "edit":
		return "badge-yellow"
	default:
		return "badge-gray"
	}
}

func formatDuration(seconds int64) string {
	if seconds == 0 {
		return "-"
	}
	if seconds < 60 {
		return fmt.Sprintf("%ds", seconds)
	}
	return fmt.Sprintf("%dm %ds", seconds/60, seconds%60)
}

templ QualityIndicator(isReviewed bool, rating int, isSuccess *bool) {
	if !isReviewed {
		<span class="text-gray-400 text-xs">—</span>
	} else {
		<div class="flex items-center gap-1">
			if isSuccess != nil {
				if *isSuccess {
					<span class="text-green-600" title="Success">✓</span>
				} else {
					<span class="text-red-600" title="Failure">✗</span>
				}
			}
			if rating > 0 {
				<span class="text-yellow-500">{ fmt.Sprintf("%d★", rating) }</span>
			}
		</div>
	}
}

templ QualityStatCard(quality *SessionQuality) {
	<div class="card">
		<div class="text-sm text-gray-500 mb-1">Quality</div>
		if quality == nil || quality.ReviewedAt == "" {
			<div class="text-2xl font-bold text-gray-400">—</div>
			<div class="text-xs text-gray-400">Not reviewed</div>
		} else {
			<div class="flex items-center gap-2">
				if quality.IsSuccess != nil {
					if *quality.IsSuccess {
						<span class="text-2xl text-green-600">✓</span>
					} else {
						<span class="text-2xl text-red-600">✗</span>
					}
				}
				if quality.OverallRating > 0 {
					<span class="text-2xl font-bold text-yellow-500">{ fmt.Sprintf("%d★", quality.OverallRating) }</span>
				}
			</div>
			<div class="text-xs text-gray-500">Reviewed</div>
		}
	</div>
}
