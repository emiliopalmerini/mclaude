package templates

import "fmt"

templ SessionsPage(data SessionsPageData) {
	@Layout("Sessions", "/sessions") {
		<div class="space-y-4">
			<div class="page-header">
				<div class="page-header-content">
					<h1 class="page-title">Sessions</h1>
					<div class="page-header-actions">
						<a href={ buildSessionsExportURL("json", data.FilterExperiment, data.FilterLimit) } class="btn btn-sm btn-secondary">Export JSON</a>
						<a href={ buildSessionsExportURL("csv", data.FilterExperiment, data.FilterLimit) } class="btn btn-sm btn-secondary">Export CSV</a>
					</div>
				</div>
			</div>

			<!-- Filters -->
			<div class="card">
				<form method="GET" action="/sessions" class="flex flex-wrap items-center gap-4">
					<!-- Experiment -->
					if len(data.Experiments) > 0 {
						<select name="experiment" class="text-sm border border-gray-300 rounded-md px-2 py-1" onchange="this.form.submit()">
							<option value="">All Experiments</option>
							for _, exp := range data.Experiments {
								<option value={ exp.ID } selected?={ exp.ID == data.FilterExperiment }>{ exp.Name }</option>
							}
						</select>
					}
					<!-- Project -->
					if len(data.Projects) > 0 {
						<select name="project" class="text-sm border border-gray-300 rounded-md px-2 py-1" onchange="this.form.submit()">
							<option value="">All Projects</option>
							for _, proj := range data.Projects {
								<option value={ proj.ID } selected?={ proj.ID == data.FilterProject }>{ proj.Name }</option>
							}
						</select>
					}
					<!-- Limit -->
					<select name="limit" class="text-sm border border-gray-300 rounded-md px-2 py-1" onchange="this.form.submit()">
						<option value="25" selected?={ data.FilterLimit == 25 }>25</option>
						<option value="50" selected?={ data.FilterLimit == 50 }>50</option>
						<option value="100" selected?={ data.FilterLimit == 100 }>100</option>
					</select>
					<span class="text-sm text-gray-500">{ fmt.Sprintf("%d sessions", len(data.Sessions)) }</span>
				</form>
			</div>

			<div class="card overflow-hidden">
				<div class="overflow-x-auto">
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-50">
							<tr>
								<th class="table-header">ID</th>
								<th class="table-header">Date</th>
								<th class="table-header">Project</th>
								<th class="table-header">Experiment</th>
								<th class="table-header">Turns</th>
								<th class="table-header">Tokens</th>
								<th class="table-header">Cost</th>
								<th class="table-header">Quality</th>
								<th class="table-header">Exit</th>
								<th class="table-header"></th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							for _, s := range data.Sessions {
								<tr class="hover:bg-gray-50">
									<td class="table-cell font-mono text-xs">
										<a href={ templ.SafeURL("/sessions/" + s.ID) } class="text-blue-600 hover:underline">{ truncateID(s.ID) }</a>
									</td>
									<td class="table-cell text-xs">{ formatDateTime(s.CreatedAt) }</td>
									<td class="table-cell text-xs truncate" style="max-width: 120px;" title={ s.ProjectName }>
										if s.ProjectName != "" {
											{ s.ProjectName }
										} else {
											<span class="text-gray-400">—</span>
										}
									</td>
									<td class="table-cell text-xs truncate" style="max-width: 100px;" title={ s.ExperimentName }>
										if s.ExperimentName != "" {
											{ s.ExperimentName }
										} else {
											<span class="text-gray-400">—</span>
										}
									</td>
									<td class="table-cell">{ fmt.Sprintf("%d", s.Turns) }</td>
									<td class="table-cell">
										<div class="token-bar-cell">
											<span class="token-bar-value">{ formatTokens(s.Tokens) }</span>
											<div class="token-bar-track">
												<div class="token-bar-fill" style={ tokenBarWidth(s.Tokens, data.MaxTokens) }></div>
											</div>
										</div>
									</td>
									<td class="table-cell text-green-600">{ fmt.Sprintf("$%.4f", s.Cost) }</td>
									<td class="table-cell">
										@QualityIndicator(s.IsReviewed, s.OverallRating, s.IsSuccess)
									</td>
									<td class="table-cell">
										<span class={ "badge", exitReasonBadge(s.ExitReason) }>{ s.ExitReason }</span>
									</td>
									<td class="table-cell">
										<button
											class="text-red-400 hover:text-red-600"
											hx-delete={ "/api/sessions/" + s.ID }
											hx-confirm="Delete this session and its transcript?"
											hx-swap="none"
											title="Delete session"
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
											</svg>
										</button>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
				if len(data.Sessions) == 0 {
					<div class="p-8 text-center text-gray-500">No sessions found</div>
				}
			</div>

			<!-- Cleanup -->
			@SessionCleanup(data)
		</div>
	}
}

templ SessionCleanup(data SessionsPageData) {
	<div class="card" x-data="{ showCleanup: false }">
		<button class="btn btn-sm btn-ghost text-red-600" x-on:click="showCleanup = !showCleanup">Cleanup Sessions...</button>
		<form
			hx-post="/api/sessions/cleanup"
			hx-swap="none"
			hx-confirm="Are you sure? This will permanently delete sessions and their transcripts."
			class="mt-4 space-y-4"
			x-show="showCleanup"
			x-cloak
		>
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<div>
					<label class="block text-sm font-medium text-gray-700 mb-1">Before Date</label>
					<input type="date" name="before_date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"/>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
					<select name="project" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
						<option value="">—</option>
						for _, proj := range data.Projects {
							<option value={ proj.ID }>{ proj.Name }</option>
						}
					</select>
				</div>
				<div>
					<label class="block text-sm font-medium text-gray-700 mb-1">Experiment</label>
					<select name="experiment" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
						<option value="">—</option>
						for _, exp := range data.Experiments {
							<option value={ exp.ID }>{ exp.Name }</option>
						}
					</select>
				</div>
			</div>
			<button type="submit" class="btn btn-sm bg-red-600 text-white hover:bg-red-700">Delete Matching Sessions</button>
		</form>
	</div>
}

templ Sessions(sessions []SessionSummary) {
	@SessionsPage(SessionsPageData{Sessions: sessions, FilterLimit: 50})
}

templ SessionDetailPage(session SessionDetail) {
	@Layout("Session Detail", "/sessions") {
		<div class="space-y-4">
			<div class="page-header">
				@Breadcrumbs([]BreadcrumbItem{
					{Label: "Sessions", Href: "/sessions"},
					{Label: truncateID(session.ID), Href: ""},
				})
				<div class="page-header-content">
					<div class="page-header-left">
						<h1 class="page-title font-mono">{ truncateID(session.ID) }</h1>
						<span class={ "badge", exitReasonBadge(session.ExitReason) }>{ session.ExitReason }</span>
					</div>
					<div class="page-header-actions">
						<a href={ templ.SafeURL("/sessions/" + session.ID + "/review") } class="btn btn-primary">
							Review Session
						</a>
						<button
							class="btn btn-secondary text-red-600 border-red-300 hover:bg-red-50"
							hx-delete={ "/api/sessions/" + session.ID }
							hx-confirm="Delete this session and its transcript?"
							hx-swap="none"
						>Delete</button>
					</div>
				</div>
			</div>

			<!-- Metrics Cards -->
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
				@StatCard("Turns", fmt.Sprintf("%d", session.TurnCount), "Conversation turns")
				@StatCard("Tokens", formatTokens(session.TokenInput + session.TokenOutput + session.TokenCacheRead + session.TokenCacheWrite), fmt.Sprintf("%s in / %s out / %s cache", formatTokens(session.TokenInput), formatTokens(session.TokenOutput), formatTokens(session.TokenCacheRead + session.TokenCacheWrite)))
				@StatCard("Cost", fmt.Sprintf("$%.4f", session.CostEstimateUsd), "Estimated cost")
				@QualityStatCard(session.Quality)
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- Details -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Details</h2>
					<dl class="space-y-3">
						@DetailRow("Project", truncateID(session.ProjectID))
						@DetailRow("Working Directory", session.Cwd)
						@DetailRow("Permission Mode", session.PermissionMode)
						@DetailRow("Created", formatDateTime(session.CreatedAt))
						if session.StartedAt != "" {
							@DetailRow("Started", formatDateTime(session.StartedAt))
						}
						if session.EndedAt != "" {
							@DetailRow("Ended", formatDateTime(session.EndedAt))
						}
					</dl>
				</div>

				<!-- Tools -->
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Tools Used</h2>
					if len(session.Tools) > 0 {
						<div class="space-y-2">
							for _, tool := range session.Tools {
								<div class="flex justify-between items-center py-2 border-b last:border-0">
									<span class="font-mono text-sm">{ tool.Name }</span>
									<span class="text-gray-600">{ fmt.Sprintf("%d", tool.Count) }x</span>
								</div>
							}
						</div>
					} else {
						<p class="text-gray-500">No tools used</p>
					}
				</div>
			</div>

			<!-- Sub-Agents -->
			if len(session.Subagents) > 0 {
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Sub-Agents</h2>
					<div class="space-y-2">
						for _, sa := range session.Subagents {
							<div class="flex justify-between items-center py-2 border-b last:border-0">
								<div class="flex items-center gap-2">
									<span class="font-mono text-sm">{ sa.AgentType }</span>
									<span class={ "badge", agentKindBadge(sa.AgentKind) }>{ sa.AgentKind }</span>
								</div>
								<div class="flex items-center gap-4 text-sm text-gray-600">
									<span>{ fmt.Sprintf("%d", sa.Count) }x</span>
									<span>{ formatTokens(sa.Tokens) } tokens</span>
									if sa.Cost > 0 {
										<span class="text-green-600">{ fmt.Sprintf("$%.4f", sa.Cost) }</span>
									}
									if sa.DurationMs > 0 {
										<span>{ fmt.Sprintf("%.1fs", float64(sa.DurationMs)/1000) }</span>
									}
								</div>
							</div>
						}
					</div>
				</div>
			}

			<!-- Files -->
			if len(session.Files) > 0 {
				<div class="card">
					<h2 class="text-lg font-semibold mb-4">Files Accessed</h2>
					<div class="space-y-1 max-h-64 overflow-y-auto">
						for _, file := range session.Files {
							<div class="flex justify-between items-center py-1 text-sm">
								<span class="font-mono text-gray-700 truncate">{ file.Path }</span>
								<span class={ "badge", opBadge(file.Operation) }>{ file.Operation }</span>
							</div>
						}
					</div>
				</div>
			}
		</div>
	}
}

templ DetailRow(label, value string) {
	<div class="flex justify-between">
		<dt class="text-gray-500">{ label }</dt>
		<dd class="text-gray-900 font-mono text-sm">{ value }</dd>
	</div>
}

func exitReasonBadge(reason string) string {
	switch reason {
	case "exit":
		return "badge-green"
	case "clear":
		return "badge-yellow"
	default:
		return "badge-gray"
	}
}

func agentKindBadge(kind string) string {
	switch kind {
	case "task":
		return "badge-blue"
	case "skill":
		return "badge-yellow"
	default:
		return "badge-gray"
	}
}

func opBadge(op string) string {
	switch op {
	case "read":
		return "badge-blue"
	case "write":
		return "badge-green"
	case "edit":
		return "badge-yellow"
	default:
		return "badge-gray"
	}
}

func formatDuration(seconds int64) string {
	if seconds == 0 {
		return "-"
	}
	if seconds < 60 {
		return fmt.Sprintf("%ds", seconds)
	}
	return fmt.Sprintf("%dm %ds", seconds/60, seconds%60)
}

templ QualityIndicator(isReviewed bool, rating int, isSuccess *bool) {
	if !isReviewed {
		<span class="text-gray-400 text-xs">—</span>
	} else {
		<div class="flex items-center gap-1">
			if isSuccess != nil {
				if *isSuccess {
					<span class="text-green-600" title="Success">✓</span>
				} else {
					<span class="text-red-600" title="Failure">✗</span>
				}
			}
			if rating > 0 {
				<span class="text-yellow-500">{ fmt.Sprintf("%d★", rating) }</span>
			}
		</div>
	}
}

templ QualityStatCard(quality *SessionQuality) {
	<div class="card">
		<div class="text-sm text-gray-500 mb-1">Quality</div>
		if quality == nil || quality.ReviewedAt == "" {
			<div class="text-2xl font-bold text-gray-400">—</div>
			<div class="text-xs text-gray-400">Not reviewed</div>
		} else {
			<div class="flex items-center gap-2">
				if quality.IsSuccess != nil {
					if *quality.IsSuccess {
						<span class="text-2xl text-green-600">✓</span>
					} else {
						<span class="text-2xl text-red-600">✗</span>
					}
				}
				if quality.OverallRating > 0 {
					<span class="text-2xl font-bold text-yellow-500">{ fmt.Sprintf("%d★", quality.OverallRating) }</span>
				}
			</div>
			<div class="text-xs text-gray-500">Reviewed</div>
		}
	</div>
}
