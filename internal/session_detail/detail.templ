package session_detail

import (
	"fmt"

	"claude-watcher/internal/database/sqlc"
	"claude-watcher/internal/shared/format"
	"claude-watcher/internal/shared/templates"
)

templ SessionDetail(s sqlc.Session) {
	@templates.Layout("Session " + format.ShortID(s.SessionID)) {
		<div class="session-header">
			<h1>Session Details</h1>
			<span class={ "status-badge", "status-" + format.NullStr(s.ExitReason) }>
				{ format.NullStr(s.ExitReason) }
			</span>
		</div>
		<section class="session-meta">
			<dl>
				<dt>Session ID</dt>
				<dd>{ s.SessionID }</dd>
				<dt>Timestamp</dt>
				<dd>{ s.Timestamp }</dd>
				<dt>Hostname</dt>
				<dd>{ s.Hostname }</dd>
				<dt>Working Directory</dt>
				<dd><code>{ format.NullStr(s.WorkingDirectory) }</code></dd>
				<dt>Git Branch</dt>
				<dd>{ format.NullStr(s.GitBranch) }</dd>
				<dt>Duration</dt>
				<dd>{ format.Duration(s.DurationSeconds) }</dd>
				<dt>Model</dt>
				<dd>{ format.NullStr(s.Model) }</dd>
				<dt>Claude Version</dt>
				<dd>{ format.NullStr(s.ClaudeVersion) }</dd>
			</dl>
		</section>
		<section>
			<h2>Activity</h2>
			<div class="stats-grid">
				@templates.StatsCard("User Prompts", format.NullIntFormatted(s.UserPrompts), "sessions")
				@templates.StatsCard("Responses", format.NullIntFormatted(s.AssistantResponses), "sessions")
				@templates.StatsCard("Tool Calls", format.NullIntFormatted(s.ToolCalls), "tokens")
				@templates.StatsCard("Errors", format.NullIntFormatted(s.ErrorsCount), "cost")
			</div>
		</section>
		<section>
			<h2>Token Usage</h2>
			<div class="token-breakdown">
				<div class="token-legend">
					<div class="token-item">
						<dt class="token-input">Input</dt>
						<dd>{ format.NullIntFormatted(s.InputTokens) }</dd>
					</div>
					<div class="token-item">
						<dt class="token-output">Output</dt>
						<dd>{ format.NullIntFormatted(s.OutputTokens) }</dd>
					</div>
					<div class="token-item">
						<dt class="token-thinking">Thinking</dt>
						<dd>{ format.NullIntFormatted(s.ThinkingTokens) }</dd>
					</div>
					<div class="token-item">
						<dt class="token-cache">Cache</dt>
						<dd>{ format.NullIntFormatted(s.CacheReadTokens) }</dd>
					</div>
					<div class="token-item" style="margin-left: auto;">
						<dt style="color: var(--color-text-secondary);">Cost</dt>
						<dd style="color: var(--color-text);">{ format.NullCostPrecise(s.EstimatedCostUsd) }</dd>
					</div>
				</div>
			</div>
		</section>
		if hasQualityData(s) {
			<section>
				<h2>Quality</h2>
				<div class="quality-scales">
					@qualityScale("Prompt Specificity", s.PromptSpecificity.Int64, s.PromptSpecificity.Valid)
					@qualityScale("Task Completion", s.TaskCompletion.Int64, s.TaskCompletion.Valid)
					@qualityScale("Code Confidence", s.CodeConfidence.Int64, s.CodeConfidence.Valid)
				</div>
			</section>
		}
		if s.ToolsBreakdown.Valid && s.ToolsBreakdown.String != "" && s.ToolsBreakdown.String != "{}" {
			<section>
				<h2>Tools Used</h2>
				<ul class="tools-list">
					for name, count := range format.ParseToolsJSON(s.ToolsBreakdown) {
						<li>
							<span class="tool-name">{ name }</span>
							<span class="tool-count">{ fmt.Sprintf("%d", count) }</span>
						</li>
					}
				</ul>
			</section>
		}
		if s.Summary.Valid && s.Summary.String != "" {
			<section>
				<h2>Summary</h2>
				<p>{ s.Summary.String }</p>
			</section>
		}
	}
}

templ qualityScale(label string, value int64, valid bool) {
	<div class="quality-scale">
		<div class="quality-scale__label">{ label }</div>
		<div class="quality-scale__bar">
			for i := 1; i <= 5; i++ {
				<div class={ "quality-scale__segment", templ.KV("quality-scale__segment--filled", valid && int64(i) <= value) }></div>
			}
		</div>
		<div class="quality-scale__value">
			if valid {
				{ fmt.Sprintf("%d", value) }
			} else {
				-
			}
		</div>
	</div>
}

func hasQualityData(s sqlc.Session) bool {
	return s.PromptSpecificity.Valid || s.TaskCompletion.Valid || s.CodeConfidence.Valid
}
